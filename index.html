<!DOCTYPE html>
<html>
<head>
  <title>Pelacak Kereta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    .info {
      position: absolute;
      top: 0;
      left: 0;
      background: #b00;
      color: white;
      padding: 10px;
      z-index: 1000;
      width: 100%;
      font-family: sans-serif;
    }
    select {
      font-size: 16px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="info">
    üöÜ <span id="kereta">Kereta Banyubiru Palur ‚Äì Yogyakarta</span><br>
    <select id="rute">
      <option value="kiri">Semarang Tawang ‚Üí Solo Balapan</option>
      <option value="kanan">Solo Balapan ‚Üí Semarang Tawang</option>
    </select><br>
    <span id="status">Status: -</span><br>
    üå°Ô∏è Suhu: N/A ‚ÑÉ üöâ Kecepatan: <span id="speed">0</span> km/jam | üìç<br>
    Stasiun berikutnya: <span id="nextStation">-</span><br>
    ‚úèÔ∏è Jarak: <span id="distance">0</span> km
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-7.0, 110.0], 9);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const stasiunData = {
      kiri: [
        ["Semarang Tawang", -6.9667, 110.4282],
        ["Alastua", -6.9868, 110.4145],
        ["Brumbung", -7.0055, 110.4936],
        ["Tanggung", -7.0999, 110.5195],
        ["Telawa", -7.2744, 110.6282],
        ["Gundih", -7.2944, 110.6778],
        ["Kedungjati", -7.2899, 110.7546],
        ["Sruwen", -7.3167, 110.7788],
        ["Brambanan", -7.7551, 110.4987],
        ["Solo Balapan", -7.5596, 110.8312]
      ],
      kanan: [
        ["Solo Balapan", -7.5596, 110.8312],
        ["Brambanan", -7.7551, 110.4987],
        ["Sruwen", -7.3167, 110.7788],
        ["Kedungjati", -7.2899, 110.7546],
        ["Gundih", -7.2944, 110.6778],
        ["Telawa", -7.2744, 110.6282],
        ["Tanggung", -7.0999, 110.5195],
        ["Brumbung", -7.0055, 110.4936],
        ["Alastua", -6.9868, 110.4145],
        ["Semarang Tawang", -6.9667, 110.4282]
      ]
    };

    let rute = 'kanan'; // default
    let userMarker;
    let stasiunSaatIniIndex = null;

    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function cariStasiun(lat, lng) {
      const list = stasiunData[rute];
      let indexTerdekat = 0;
      let jarakTerdekat = Infinity;

      for (let i = 0; i < list.length; i++) {
        const [_, stLat, stLng] = list[i];
        const jarak = getDistance(lat, lng, stLat, stLng);
        if (jarak < jarakTerdekat) {
          jarakTerdekat = jarak;
          indexTerdekat = i;
        }
      }

      const [nama, stLat, stLng] = list[indexTerdekat];
      const jarak = getDistance(lat, lng, stLat, stLng);
      return { nama, jarak, index: indexTerdekat };
    }

    function updatePosisi(pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const speed = pos.coords.speed ? (pos.coords.speed * 3.6).toFixed(1) : 0;

      document.getElementById("speed").textContent = speed;

      if (userMarker) map.removeLayer(userMarker);
      userMarker = L.marker([lat, lng], {
        icon: L.icon({
          iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61088.png",
          iconSize: [30, 30]
        })
      }).addTo(map);

      const hasil = cariStasiun(lat, lng);
      let namaStasiun = hasil.nama;
      let jarak = hasil.jarak;
      let status = "Berjalan";

      if (jarak < 0.1 && speed < 3) {
        status = `Berhenti di stasiun ${namaStasiun}`;
        stasiunSaatIniIndex = hasil.index;
      }

      let nextNama = "-";
      let nextJarak = 0;

      if (stasiunSaatIniIndex !== null && stasiunSaatIniIndex + 1 < stasiunData[rute].length) {
        const [nextName, nextLat, nextLng] = stasiunData[rute][stasiunSaatIniIndex + 1];
        nextNama = nextName;
        nextJarak = getDistance(lat, lng, nextLat, nextLng);
      } else {
        nextNama = hasil.nama;
        nextJarak = hasil.jarak;
      }

      document.getElementById("status").textContent = `Status: ${status}`;
      document.getElementById("nextStation").textContent = nextNama;
      document.getElementById("distance").textContent = nextJarak.toFixed(2);
    }

    function errorPosisi(err) {
      alert("Gagal mendapatkan lokasi: " + err.message);
    }

    navigator.geolocation.watchPosition(updatePosisi, errorPosisi, {
      enableHighAccuracy: true,
      maximumAge: 0
    });

    document.getElementById("rute").addEventListener("change", function () {
      rute = this.value;
      stasiunSaatIniIndex = null;
    });
  </script>
</body>
</html>